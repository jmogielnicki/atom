var esprima = require('esprima-fb');
var recast = require('recast');
var mapToStream = require('map-stream');
var File = require('vinyl');
var parser;

function parse(file, cb) {

    console.log("ast stream, file:", file.path )
    if (file.contents) {
        var code = file.contents.toString();
        try {
            var ast;
            if (file.extname == '.js') {
                ast = recast.parse(code, {
                    parser: parser
                });
            } else
                ast = parser.parse(code);
        } catch (e) {
            console.error("Error (ast-stream): ", e)
            cb(null, file);
            return;
        }
        var result = file.clone();
        result.ast = ast;
        cb(null, result);
    } else {
        console.log("ast stream, no contents: ", file.path)
        cb(null, file);
    }
}

module.exports = function (parser_) {
    parser = parser_ || esprima;
    var s = mapToStream(parse);
    s.setMaxListeners(100000);
    return s;
}
